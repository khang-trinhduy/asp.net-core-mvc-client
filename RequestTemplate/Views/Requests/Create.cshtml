<div class="request-area">
    <div id="request-title">
        <label class="control-label">Flow: </label>
        <input id="request-name" type="text" class="form-control" placeholder="Tên quy trình"/>
        <span id="name-validation">Bắt buộc</span>
        <label class="control-label">Loại: </label>
        <div class="custom-control custom-radio">
            <input type="radio" id="auto-proceed" name="customRadio" checked class="custom-control-input">
            <label class="custom-control-label" for="auto-proceed">Không cần người thẩm định</label>
        </div>
        <div class="custom-control custom-radio">
            <input type="radio" id="manual-proceed" name="customRadio" class="custom-control-input">
            <label class="custom-control-label" for="manual-proceed">Cần người thẩm định</label>
        </div>
    </div>
</div>

<div class="state-area">
    <div class="add-state-area">
        <label for="">Chọn loại công việc:</label>
        <select id="select-state" asp-items="@ViewBag.statemplate">
            <option value="new">Khác</option>
        </select>
        <div class="state-icon">
            <!-- <i id="" class="far fa-plus-square" title="Thêm"></i> -->
            <i id="generic" class="fas fa-tasks" title="Thông thường"></i>
            <i id="absent" class="far fa-address-card" title="Nghỉ phép"></i>
            <i id="email" class="fas fa-envelope" title="Email"></i>
            <i id="file" class="fas fa-file-upload" title="Upload file"></i>
            <i id="edit" class="far fa-edit" title="Chỉnh sửa"></i>
            <i id="comment" class="far fa-comment" title="Comment"></i>
            <div class="states-partial">

            </div>
        </div>
    </div>
</div>
<div class="submit-work-flow">
    <button id="btn-submit" class="btn btn-default">Lưu lại</button>
</div>
<style>
    .far, .fas{
        margin-left: 10px;
    }
</style>

<script>
    var ids = [];
    var curId = 0;
    function createstate(id, type) {  
        var state_view = '<div class="state-header">' +
            '<div class="state-name' + id +'">' +
            '<label hidden id="state-label' + id + '" class="control-label">' +
                'Tên đầu việc: ' +
            '</label>' +
            '<input hidden id="state-name' + id + '" type="text" class="form-control"/>' +
            '<span hidden id="state-validation' + id + '">Bắt buộc</span>' +
            '<select hidden class="form-control" id="state-type' + id + '">' +
                '<option value="normal">Trung gian</option>' + 
                '<option value="start">Bắt đầu</option>' + 
                '<option value="end">Kết thúc</option>' + 
            '</select>' + 
            '<div id="state-time' + id + '" hidden>' + 
            '<label class="control-label">Thời gian bắt đầu</label>' +
            '<input type="date" class="form-control" id="state-eta' + id +'" />' +
            '</div>' +
            '<div class="activity-area' + id + '">' +
            '<label for="">Tên công việc: </label>';
            
        switch (type) {
            case 'CONTACT':
                return '';
                break;
            case 'FILEULTI':
                return '';
                break;
            case 'EDIT':
                return '';
                break;
            case 'ABSENT':
                if ($('#manual-proceed').is(':checked')) {
                    state_view += '<div class="absent-contents">' +
                            '<input type="text" class="form-control" placeholder="Tên công việc" id="activity-name' + id + '" value="Xin nghỉ phép">' +
                            '<label hidden onclick="toggling()" class="control-label">Mô tả chi tiết</label>' +
                            '<input type="text" class="form-control" placeholder="Mô tả nội dung công việc" id="activity-desc' + id + '">' +
                            '<span hidden>Thời gian thực hiện công việc (giờ): </span> <input type="number" class="form-control" id="activity-dura' + id + '" hidden value="1">' +
                            '<label class="control-label">Tên nhân viên</label>' +
                            '<input type="text" class="form-control" placeholder="Tên nhân viên" id="activity-worker' + id + '" value="Nguyễn Văn A">' +
                            '<label class="control-label">Ngày vắng mặt: </label> <input type="date" type="text" class="form-control" placeholder="Ngày vắng mặt" id="activity-off-day' + id + '">' +
                            '<label class="control-label">Lý do</label>' + 
                            '<textarea class="form-control" placeholder="Lý do" rows="3" id="activity-reason' + id + '">Có việc gấp</textarea>' +
                            '<span hidden id="activity-type' + id + '">ABSENT</span>' + 
                            '</div>' +
                            '<div class="role-area"><span hidden>Đối tượng thực hiện:</span>' +
                                    '<select hidden class="form-control" id="role-type' + id + '" multiple>' +
                                        '<option selected value="hr">Bộ phận nhân sự</option>' +
                                        '<option selected value="crm">Bộ phận nghiệp vụ</option>' +
                                        '<option value="other">Khác</option>' +
                                    '</select>' +
                            '</div>' +
                        '</div>';
                }
                else{
                    alert("Chuyển loại quy trình sang \"Cần người thẩm định\" để tạo loại yêu cầu \"Vắng mặt\"");
                }
                break;
            case 'EMAIL':
                return '';
                break;
            case 'GENERIC':
                state_view += '<div class="generic-contents">' +
                        '<input type="text" class="form-control" placeholder="" id="activity-name' + id + '">' +
                        '<div><label id="detail-label" onclick="toggling(this)" class="control-label">Mô tả chi tiết</label>' +
                        '<input type="text" class="form-control" placeholder="Mô tả nội dung công việc" id="activity-desc' + id + '"></div>' +
                        '<label class="control-label" onclick="toggling(this)">Thời gian thực hiện công việc (giờ): </label> <input type="number" class="form-control" id="activity-dura' + id + '">' +
                        '<label hidden id="activity-type' + id + '">GENERIC</label>' + 
                        '</div>' +
                        '<div class="role-area"><label class="control-label">Đối tượng thực hiện:</label>' +
                                '<select class="form-control" id="role-type' + id + '" multiple>' +
                                    '<option value="hr">Bộ phận nhân sự</option>' +
                                    '<option value="cm">Bộ phận nghiệp vụ</option>' +
                                    '<option value="other">Khác</option>' +
                                '</select>' +
                        '</div>' +
                    '</div>';
                break;
        }
        state_view += '</div>';
        return state_view;
    }
    function toggling(self) {
        $(self).next('input').slideToggle();
    }

    function hide_validation(cur, id) {
        var new_id = id + ' ' + cur;
        alert(new_id);
        $(new_id).toggle();
    }
    function addActivity(id, type) {
        console.log('jumped into addactivity');
        console.log(type);
        var new_id = id * 10 + ids[id-1];
        ids[id-1]++;
        add_activity(new_id, type);
        // $('.selectpicker').selectpicker();
    }
    function add_activity(type) {
        var activity_view = '';
        switch (type) {
            case 'CONTACT':
                
                break;
            case 'FILEULTI':
                
                break;
            case 'EDIT':
                
                break;
            case 'ABSENT':
                if ($('#manual-proceed').is(':checked')) {
                    activity_view = '<div class="absent-contents">' +
                            '<input hidden type="text" class="form-control" placeholder="Tên đầu việc" id="activity-name' + id + '" value="Xin nghỉ phép">' +
                            '<input type="text" class="form-control" placeholder="Mô tả nội dung công việc" id="activity-desc' + id + '" hidden value="">' +
                            '<span hidden>Thời gian thực hiện công việc (giờ): </span> <input type="number" class="form-control" id="activity-dura' + id + '" hidden value="1">' +
                            '<input type="text" class="form-control" placeholder="Tên nhân viên" id="activity-worker' + id + '" value="Nguyễn Văn A">' +
                            '<span>Ngày vắng mặt: </span> <input type="date" type="text" class="form-control" placeholder="Ngày vắng mặt" id="activity-off-day' + id + '">' +
                            '<textarea class="form-control" placeholder="Lý do" rows="3" id="activity-reason' + id + '">Có việc gấp</textarea>' +
                            '<span hidden id="activity-type' + id + '">ABSENT</span>' + 
                            '</div>' +
                            '<div class="role-area"><span hidden>Đối tượng thực hiện:</span>' +
                                    '<select hidden class="form-control" id="role-type' + id + '" multiple>' +
                                        '<option selected value="hr">Bộ phận nhân sự</option>' +
                                        '<option selected value="crm">Bộ phận nghiệp vụ</option>' +
                                        '<option value="other">Khác</option>' +
                                    '</select>' +
                            '</div>' +
                        '</div>';
                }
                else{
                    alert("Chuyển loại quy trình sang \"Cần người thẩm định\" để tạo loại yêu cầu \"Vắng mặt\"");
                    activity_view = '';
                }
                break;
            case 'EMAIL':
                
                break;
            case 'GENERIC':
                activity_view = '<div class="generic-contents">' +
                        '<input type="text" class="form-control" placeholder="Tên đầu việc" id="activity-name' + id + '">' +
                        '<input type="text" class="form-control" placeholder="Mô tả nội dung công việc" id="activity-desc' + id + '">' +
                        '<span>Thời gian thực hiện công việc (giờ): </span> <input type="number" class="form-control" id="activity-dura' + id + '">' +
                        '<span hidden id="activity-type' + id + '">GENERIC</span>' + 
                        '</div>' +
                        '<div class="role-area">' +
                                '<select class="form-control" id="role-type' + id + '" multiple>' +
                                    '<option value="hr">Bộ phận nhân sự</option>' +
                                    '<option value="cm">Bộ phận nghiệp vụ</option>' +
                                    '<option value="other">Khác</option>' +
                                '</select>' +
                        '</div>' +
                    '</div>';
                break;
                
        }
        var elem = '.activity-area' + id.toString().charAt(0);
        console.log(elem);
        $(elem).append(activity_view);
        // $('.selectpicker').selectpicker();
    }
    $('#name-validation').toggle();
    $('.state-icon>i').on('click', function () {
        $('.states-partial').append(createstate(curId + 1, $(this).attr('id').toUpperCase()));
        $('#activity-desc' + (curId + 1).toString()).slideToggle();
        $('#activity-dura' + (curId + 1).toString()).slideToggle();
        ids.push(0);
        curId++;
    }); 

    $('#btn-submit').on('click', function (params) {
        var request = {};
        var states = [];
        request['title'] = $('#request-name').val();
        if(request['title'] == undefined)
        {
            alert("Nhập tên quy trình");
        }
        request['process'] = {};
        request['process']['states'] = [];
        request['process']['actions'] = [];
        request['process']['roles'] = [];
        request['process']['rules'] = [];
        request['process']['activities'] = [];
        var idns = document.querySelectorAll('[id]');
        for (let i = 1; i <= ids.length; i++) {
            state = {};
            activity = {};

            state['name'] = activity['name'] = $('#activity-name' + i.toString()).val();
            activity['description'] = $('#activity-desc' + i.toString()).val();
            activity['duration'] = $('#activity-dura' + i.toString()).val();
            activity['activitytype'] = $('#activity-type' + i.toString()).text();
            var roles =$('#role-type' + i.toString()).val();
            activity['roles'] = [];
            activity['absentname'] = $('#activity-worker' + i.toString()).val();
            activity['dayoff'] = $('#activity-off-day' + i.toString()).val();
            <!-- activity['isreallynotapproved'] = $('#activity-reason' + i.toString()).val(); -->
            <!-- activity['approvername'] = $('#activity-worker' + i.toString()).val(); -->
            activity['reason'] = $('#activity-reason' + i.toString()).val();
            roles.forEach(element => {
                if(!activity['roles'].some(e => e.name === element)) {
                    activity['roles'].push({'name': element});
                }
            });
            state['eta'] = $('#state-eta' + i.toString()).val();
            state['activities'] = [];
            state['activities'].push(activity);
            if(i == 1)
            {
                state['statetype'] = 'start';
            }
            else if(i == ids.length)
            {
                state['statetype'] = 'end';                
            }
            else
            {
                state['statetype'] = 'normal';   
            }
            states.push(state.name);

            
            request['process']['states'].push(state);
        }
        if ($('#auto-proceed').is(':checked')) {
            request['process']['actions'] = ['auto'];
            for (let index = 0; index < states.length - 1; index++) {
                var rule = {'action': 'auto advance', 'currentstate': states[index], 'nextstate': states[index + 1]};
                request['process']['rules'].push(rule);
            }
        }
        else{
            var action = {'name': 'approve'};
            var another_action = {'name': 'deny'};
            request['process']['actions'].push(action);
            request['process']['actions'].push(another_action);
            for (let index = 0; index < states.length - 1; index++) {
                var rule = {'action': 'approve', 'currentstate': states[index], 'nextstate': states[index + 1]};
                var another_rule = {'action': 'deny', 'currentstate': states[index], 'nextstate': states[index + 1]};
                request['process']['rules'].push(rule);
                request['process']['rules'].push(another_rule);
            }
        }
        request['currentstate'] = states[0];
        console.log(request);
        $.ajax({
            type: "post",
            url: '@Url.Action("create", "requests")',
            data: request,
            dataType: "json",
            header: {
                'content-type': 'application/json'
            },
            success: function (response) {
                console.log(response);
                alert(response);
            },
            error: function () {
                console.log('error');              
            }
        });
    });
</script>